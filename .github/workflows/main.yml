name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: List repository contents
      run: ls -la
      
    - name: Check package.json exists
      run: |
        if [ -f "package.json" ]; then
          echo "package.json exists"
          cat package.json
        else
          echo "package.json does not exist"
          exit 1
        fi
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        echo "Installing dependencies..."
        npm install
        echo "Dependencies installed"
        npm list --depth=0
      
    - name: Check next.config.js
      run: |
        if [ -f "next.config.js" ]; then
          echo "next.config.js exists"
          cat next.config.js
        else
          echo "next.config.js does not exist"
          exit 1
        fi
      
    - name: Build Next.js app
      run: |
        echo "Building Next.js app..."
        npm run build
        echo "Build completed"
        ls -la out/
      
    - name: Install Capacitor CLI
      run: |
        echo "Installing Capacitor CLI..."
        npm install -g @capacitor/cli
        echo "Capacitor CLI installed"
        npx cap --version
      
    - name: Check capacitor.config.ts
      run: |
        if [ -f "capacitor.config.ts" ]; then
          echo "capacitor.config.ts exists"
          cat capacitor.config.ts
        else
          echo "capacitor.config.ts does not exist"
          exit 1
        fi
      
    - name: Add Android platform
      run: |
        echo "Adding Android platform..."
        npx cap add android
        echo "Android platform added"
      
    - name: Sync Capacitor
      run: |
        echo "Syncing Capacitor..."
        npx cap sync android
        echo "Capacitor synced"
      
    - name: Make gradlew executable
      run: |
        echo "Making gradlew executable..."
        chmod +x android/gradlew
        echo "gradlew is now executable"
      
    - name: List Android directory
      run: |
        echo "Android directory contents:"
        ls -la android/
        echo "Android app directory contents:"
        ls -la android/app/
      
    - name: Build debug APK
      run: |
        echo "Building debug APK..."
        cd android
        ./gradlew assembleDebug --info
        echo "APK build completed"
        
    - name: Check if APK was built
      run: |
        if [ -f "android/app/build/outputs/apk/debug/app-debug.apk" ]; then
          echo "APK was built successfully"
        else
          echo "APK was not built"
          echo "Checking build directory:"
          ls -la android/app/build/outputs/ || echo "Outputs directory doesn't exist"
          exit 1
        fi
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: dream-clock-debug-apk
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
